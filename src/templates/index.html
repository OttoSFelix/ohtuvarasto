<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Varasto - Warehouse Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè≠ Varasto Manager</h1>
            <p class="subtitle">Warehouse Management System</p>
        </header>

        <section class="create-warehouse">
            <h2>Create New Warehouse</h2>
            <form id="create-form">
                <div class="form-group">
                    <label for="tilavuus">Capacity (tilavuus):</label>
                    <input type="number" id="tilavuus" name="tilavuus" step="0.1" min="0" required placeholder="Enter capacity">
                </div>
                <div class="form-group">
                    <label for="alku_saldo">Initial Balance (alku_saldo):</label>
                    <input type="number" id="alku_saldo" name="alku_saldo" step="0.1" min="0" value="0" placeholder="Enter initial balance">
                </div>
                <button type="submit" class="btn btn-primary">Create Warehouse</button>
            </form>
        </section>

        <section class="warehouses">
            <h2>Your Warehouses</h2>
            <div id="warehouses-container">
                <p class="empty-message">No warehouses created yet. Create one above!</p>
            </div>
        </section>
    </div>

    <script>
        const warehousesContainer = document.getElementById('warehouses-container');

        // Load existing warehouses on page load
        async function loadWarehouses() {
            const response = await fetch('/api/warehouses');
            const warehouses = await response.json();

            if (Object.keys(warehouses).length === 0) {
                warehousesContainer.innerHTML = '<p class="empty-message">No warehouses created yet. Create one above!</p>';
                return;
            }

            warehousesContainer.innerHTML = '';
            for (const [id, data] of Object.entries(warehouses)) {
                addWarehouseCard(id, data);
            }
        }

        function addWarehouseCard(id, data) {
            const card = document.createElement('div');
            card.className = 'warehouse-card';
            card.id = `warehouse-${id}`;
            card.innerHTML = `
                <div class="warehouse-header">
                    <h3>Warehouse #${id}</h3>
                    <button class="btn btn-danger btn-small" onclick="deleteWarehouse('${id}')">Delete</button>
                </div>
                <div class="warehouse-stats">
                    <div class="stat">
                        <span class="stat-label">Capacity:</span>
                        <span class="stat-value">${data.tilavuus}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Current Balance:</span>
                        <span class="stat-value" id="saldo-${id}">${data.saldo}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Space Available:</span>
                        <span class="stat-value" id="tilaa-${id}">${data.tilaa}</span>
                    </div>
                </div>
                <div class="warehouse-actions">
                    <button class="btn btn-info" onclick="checkSpaceLeft('${id}')">Check Space Left (paljonko_mahtuu)</button>
                    
                    <div class="action-group">
                        <input type="number" id="add-amount-${id}" step="0.1" min="0" placeholder="Amount to add">
                        <button class="btn btn-success" onclick="addToWarehouse('${id}')">Add (lisaa_varastoon)</button>
                    </div>
                    
                    <div class="action-group">
                        <input type="number" id="take-amount-${id}" step="0.1" min="0" placeholder="Amount to take">
                        <button class="btn btn-warning" onclick="takeFromWarehouse('${id}')">Take (ota_varastosta)</button>
                    </div>
                </div>
                <div class="result-box" id="result-${id}" style="display: none;">
                    <p id="result-text-${id}"></p>
                </div>
            `;
            warehousesContainer.appendChild(card);
        }

        function showResult(id, message) {
            const resultBox = document.getElementById(`result-${id}`);
            const resultText = document.getElementById(`result-text-${id}`);
            resultText.textContent = message;
            resultBox.style.display = 'block';
            resultBox.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                resultBox.classList.remove('show');
                setTimeout(() => {
                    resultBox.style.display = 'none';
                }, 300);
            }, 5000);
        }

        function updateWarehouseDisplay(id, saldo, tilaa) {
            document.getElementById(`saldo-${id}`).textContent = saldo;
            document.getElementById(`tilaa-${id}`).textContent = tilaa;
        }

        // Create warehouse
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tilavuus = parseFloat(document.getElementById('tilavuus').value);
            const alku_saldo = parseFloat(document.getElementById('alku_saldo').value) || 0;

            const response = await fetch('/api/warehouses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tilavuus, alku_saldo })
            });

            const data = await response.json();

            // Remove empty message if present
            const emptyMsg = warehousesContainer.querySelector('.empty-message');
            if (emptyMsg) emptyMsg.remove();

            addWarehouseCard(data.id, data);

            // Reset form
            document.getElementById('create-form').reset();
        });

        // Check space left
        async function checkSpaceLeft(id) {
            const response = await fetch(`/api/warehouses/${id}/paljonko_mahtuu`);
            const data = await response.json();
            showResult(id, `Space left: ${data.tilaa}`);
        }

        // Validate and parse amount from input
        function getValidAmount(inputId, warehouseId) {
            const input = document.getElementById(inputId);
            const amount = parseFloat(input.value);
            if (isNaN(amount)) {
                showResult(warehouseId, 'Please enter a valid amount');
                return null;
            }
            return { amount, input };
        }

        // Add to warehouse
        async function addToWarehouse(id) {
            const result = getValidAmount(`add-amount-${id}`, id);
            if (!result) return;
            const { amount: maara, input } = result;

            const response = await fetch(`/api/warehouses/${id}/lisaa`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ maara })
            });

            const data = await response.json();
            updateWarehouseDisplay(id, data.saldo, data.tilaa);
            showResult(id, `Added ${maara} to warehouse. New balance: ${data.saldo}`);
            input.value = '';
        }

        // Take from warehouse
        async function takeFromWarehouse(id) {
            const result = getValidAmount(`take-amount-${id}`, id);
            if (!result) return;
            const { amount: maara, input } = result;

            const response = await fetch(`/api/warehouses/${id}/ota`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ maara })
            });

            const data = await response.json();
            updateWarehouseDisplay(id, data.saldo, data.tilaa);
            showResult(id, `Took ${data.otettu} from warehouse. New balance: ${data.saldo}`);
            input.value = '';
        }

        // Delete warehouse
        async function deleteWarehouse(id) {
            if (!confirm('Are you sure you want to delete this warehouse?')) return;

            await fetch(`/api/warehouses/${id}`, { method: 'DELETE' });
            document.getElementById(`warehouse-${id}`).remove();

            if (warehousesContainer.children.length === 0) {
                warehousesContainer.innerHTML = '<p class="empty-message">No warehouses created yet. Create one above!</p>';
            }
        }

        // Load warehouses on page load
        loadWarehouses();
    </script>
</body>
</html>
